# Feature Specification: mllm Memory Enhancement

**Feature Branch**: `001-mllm-memory-enhancement`
**Created**: 2025-12-29
**Status**: Draft
**Input**: User description: "mllmの品質向上のための大規模改善"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 高品質な会話応答 (Priority: P1)

Botがユーザーの発言に対して、過去の会話履歴と類似した話題、さらにユーザー情報を考慮した上で、より文脈に沿った自然な応答を返す。

**Why this priority**: mllmの品質向上がこの機能の核心であり、ユーザー体験に直接影響する最重要機能。

**Independent Test**: ユーザーがBotに話しかけた際、直近の会話内容・類似メッセージ・ユーザー情報が応答に反映されているか確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーAが過去に「猫が好き」と発言している、**When** ユーザーAが「最近どんなペット飼ってる人多い？」と質問、**Then** Botは過去のユーザーAの猫好き情報を踏まえた応答を返す
2. **Given** チャンネル内で直前に「今日は寒い」という会話があった、**When** ユーザーBが「外出るべき？」と質問、**Then** Botは直近の「寒い」という文脈を踏まえた応答を返す
3. **Given** ユーザーCのプロフィールに特定の趣味が登録されている、**When** ユーザーCがBotに話しかける、**Then** Botはそのユーザー情報を考慮した応答を生成できる

---

### User Story 2 - Discordメッセージの自動保存と検索 (Priority: P1)

Discordチャンネルで発言されたメッセージが自動的に保存され、後から意味的に類似したメッセージを検索できる。

**Why this priority**: メッセージの保存と検索基盤がなければ、P1の高品質応答機能が動作しない。

**Independent Test**: メッセージを送信後、ベクトル検索で類似メッセージが取得できることを確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーが5文字以上の通常メッセージを投稿、**When** メッセージが送信される、**Then** メッセージがデータベースとベクトルDBに保存される
2. **Given** 複数のメッセージが保存されている、**When** 意味的に類似したクエリで検索、**Then** 関連するメッセージがスコア順で返される
3. **Given** Botへのコマンド（!で始まる）メッセージが投稿された、**When** メッセージ処理、**Then** そのメッセージはベクトルDBには保存されない

---

### User Story 3 - ユーザー情報の管理と定期更新 (Priority: P2)

Discordユーザーの情報（表示名、アバター等）が保存され、定期的に最新状態に更新される。

**Why this priority**: ユーザー情報はP1の応答品質向上に寄与するが、なくても基本機能は動作する。

**Independent Test**: ユーザー情報がDBに保存され、定期タスクで更新されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 新しいユーザーがメッセージを投稿、**When** そのユーザーがDBに存在しない、**Then** ユーザー情報が新規登録される
2. **Given** ユーザー情報がDBに存在、**When** 定期更新タスクが実行、**Then** 最新のDiscord情報でDBが更新される

---

### User Story 4 - 初回データ取得機能 (Priority: P2)

Bot開発者が特定チャンネルの過去メッセージを一括取得し、システムに初期データを投入できる。

**Why this priority**: 新規デプロイ時にデータがゼロの状態を回避でき、すぐにmllmの品質を発揮できる。

**Independent Test**: 指定チャンネルの過去100件程度のメッセージが取得・保存されることを確認できる。

**Acceptance Scenarios**:

1. **Given** Bot開発者が認証済み、**When** チャンネルIDを指定して初回fetch APIを呼び出す、**Then** そのチャンネルの過去メッセージがDBとベクトルDBに保存される
2. **Given** 一般ユーザーが初回fetch APIを呼び出す、**When** リクエストを送信、**Then** 認証エラーが返される

---

### Edge Cases

- 5文字未満のメッセージは保存されない
- URLのみ、絵文字のみなどノイズと判断されるメッセージはベクトルDBに保存されない
- Bot自身の発言は会話履歴から除外される
- Discord APIのレート制限時は適切にエラーハンドリングする
- ベクトルDBに保存済みのメッセージIDで再度保存リクエストが来た場合は更新（upsert）される
- メッセージが編集された場合、DBとベクトルDBの両方が更新される
- メッセージが削除された場合、DBとベクトルDBの両方から削除される
- 添付ファイルのみ（テキストなし）のメッセージはDBに保存するが、ベクトルDBには保存しない

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはDiscordメッセージをデータベースに永続化できなければならない（メッセージID、チャンネルID、ユーザーID、内容、タイムスタンプを含む）
- **FR-002**: システムはDiscordユーザー情報をデータベースに保存できなければならない（ユーザーID、表示名、アバターURL、最終更新日時を含む）
- **FR-003**: システムは5文字以上かつ有意なコンテンツを持つメッセージのみをベクトルDBに保存しなければならない
- **FR-004**: システムはメッセージ全文をベクトル化し、DiscordメッセージIDをメタデータとして保存しなければならない
- **FR-005**: システムはBotコマンド（!で始まる）メッセージをベクトルDBから除外しなければならない
- **FR-006**: システムはURL、絵文字のみなどのノイズメッセージをベクトルDBから除外しなければならない
- **FR-007**: mllmは直近N件の会話（Bot発言除く）をコンテキストに含めなければならない
- **FR-008**: mllmは類似メッセージM件をベクトル検索で取得しコンテキストに含めなければならない
- **FR-009**: mllmは対象ユーザーの情報をコンテキストに含めなければならない
- **FR-010**: システムはScheduled Triggerでユーザー情報を定期更新できなければならない
- **FR-011**: 認可されたユーザーのみが初回fetch機能を実行できなければならない
- **FR-012**: 初回fetch機能は指定チャンネルから一定数のメッセージを取得・保存できなければならない
- **FR-013**: システムはメッセージ編集時にDBとベクトルDBの両方を更新しなければならない
- **FR-014**: システムはメッセージ削除時にDBとベクトルDBの両方から削除しなければならない

### Key Entities

- **DiscordMessage**: Discord上のメッセージを表す。メッセージID、チャンネルID、ユーザーID、内容、タイムスタンプ、ベクトル化済みフラグ、返信先メッセージID、メンション情報を持つ
- **DiscordUser**: Discordユーザーを表す。ユーザーID、表示名、アバターURL、最終更新日時を持つ
- **VectorizedMessage**: ベクトルDBに保存されたメッセージ。DiscordメッセージIDをキーとし、メッセージ全文のベクトル表現を持つ

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: mllmの応答が過去の会話文脈を反映している（手動評価で10件中8件以上が文脈を反映）
- **SC-002**: 類似メッセージ検索が1秒以内に結果を返す
- **SC-003**: メッセージ保存処理がDiscord APIレスポンス後100ms以内に完了する
- **SC-004**: ユーザー情報の定期更新が1日1回以上実行される
- **SC-005**: 初回fetch機能が100件のメッセージを5分以内に処理できる
- **SC-006**: ノイズフィルタリングにより、意味のないメッセージがベクトルDBから95%以上除外される

## Clarifications

### Session 2025-12-29

- Q: 保存するメッセージデータの範囲は？ → A: テキスト重視（Content, ID, ChannelID, UserID, Timestamp + ReferencedMessage, MentionRoles, Mentions）
- Q: 返信メッセージのベクトル化方法は？ → A: 返信メッセージ単体のみベクトル化（元メッセージは参照IDのみ保持）
- Q: メッセージの編集・削除の扱いは？ → A: 編集は更新、削除はDBとベクトルDBから両方削除
- Q: 添付ファイルのみのメッセージの扱いは？ → A: DBには保存するが、ベクトルDBには保存しない（検索対象外）
- Q: データ保持期間は？ → A: 無期限保持（削除はDiscord側の削除イベントのみに連動）

## Assumptions

- Discord APIへのアクセス権限は既に確保されている（Bot tokenが有効）
- Cloudflare WorkerのScheduled Triggerが利用可能
- 既存のVectorize（nelchan-memory-index）を引き続き使用する
- 初回fetchの対象チャンネルはBot開発者が手動で指定する
- 直近の会話件数Nと類似メッセージ件数Mは設定可能とする（デフォルト値: N=10, M=5）
- データは無期限保持し、自動削除は行わない（Discord側の削除イベントに連動）
